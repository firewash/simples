<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>验证css3在android手机上的效率</title>
    <script src="promise-polyfill.js"></script>
    <meta id="vp" name="viewport" content="width=640,height=1136, initial-scale=0.2, maximum-scale=1.0, user-scalable=0">
    <style>
        html,body{
            margin:0;padding:0;overflow:hidden;
        }
    </style>
    <script>
        window.onerror=function(e){alert(e)}
        var virture_width = 640,
                virture_height = 1136,
                device_width = window.screen.width,
                scale = device_width/640;
        document.write('<meta name="viewport" content="width='+virture_width+',height='+virture_height+', initial-scale='+scale+', maximum-scale=1.0, user-scalable=0">');

    </script>
</head>
<body class="wrapper">
<script>
    //基于CSS3动画的能力封装
    (function (NS) {
        var keyframe_name_index = 0,
                keyframeNameGen = function () {
                    return "CSSAnimationKeyFrame_" + keyframe_name_index++;
                };

        var styleTag = (function () {
            var style = document.createElement("style");
            style.setAttribute("data-role", "for-animation-css3");
            document.head.appendChild(style);
            return style;
        })();
        var sheet = styleTag.sheet;

        //让出入的rule自动加上前缀(低配手机还是需要的)
        var cssprefix = (function(){
                var div = document.createElement('div');
                var style = div.style;
                if (style.hasOwnProperty("webkitTransition")) {
                    return '-webkit-';
                } else if (style.hasOwnProperty("MozTransition")) {
                    return '-moz-';
                } else if (style.hasOwnProperty("oTransition")) {
                    return '-o-';
                } else if (style.hasOwnProperty("msTransition")) {
                    return '-ms-';
                }else return '';
            })(),
            cssfix = function(prop){
                return cssprefix + prop;
            };

        //创建帧动画css规则,使用JSON数据
        function createFrameRule(rule) {
            var name = keyframeNameGen();
            var temp = ["@"+cssfix("keyframes")," ", name, "{"];
            for (var framekey in rule) {
                var frame = rule[framekey];
                temp.push(framekey, "{")
                //特殊处理一下tx,ty语法糖
                var transform = frame["transform"] || "";
                transform += frame.tx ? " translateX(" + frame.tx + ")" : ""; //todo: tx, ty还不生效
                transform += frame.ty ? " translateY(" + frame.ty + ")" : "";
                if (transform)frame[cssfix("transform")] = transform;

                for (var csskey in frame) {
                    var cssvalue = frame[csskey];
                    if (cssvalue)temp.push(csskey, ":", cssvalue, ";");
                }
                temp.push("}");
            }
            temp.push("}");
            var ruleString = temp.join("");
            console.log(ruleString)
            sheet.insertRule(ruleString, 0);
            return name;
        }

        /**
         * rules={
         *  0 {"left":"1","top":"10px;"}
         *
         *  2% {"left":"10px"}
         * }
         * */
        function animate(opt, callback) {
            var dom = opt.dom.tagName?opt.dom:document.getElementById(opt.dom) ;
            if(!dom){console.log("No dom for animate");return;};
            var duration = opt.duration || "1s",
                loop = opt.loop || 1,
                direction = "normal",
                timing = opt.timing || "linear",
                fillmode = "forwards", //animation-fill-mode : none | forwards | backwards | both;
                delay = opt.delay || "0s",
                rule = opt.rule;
            if(!(rule["100%"]||rule["to"])){
                console.log("No (100%) or (to) anmition frame, animation play error")
            }
            if(!(rule["0%"]||rule["from"])){
                console.log("No (0%) or (from) anmition frame, animation play error"); // 虽然不是必须,但是我们这样要求,会让设置更简单
            }
            var animName = createFrameRule(rule);
            //设置动画元素初始状态,防止跳动
            var firstFrame = rule["0%"]||rule["from"];
            for(var prop in firstFrame){
                dom.style["prop"] = firstFrame[prop];
            }
            //<animation-name><duration-time><timing-function><delay-time><animation-iteration-count><animation-direction><animation-fill-mode><single-animation-play-state>
            dom.style[cssfix("animation")] = [duration, animName, timing, delay, loop,  direction, fillmode].join(" ");

            dom.style.display = "block";

            dom.addEventListener("webkitAnimationEnd", function () {
                console.log("Animation end;");
                callback && callback.apply(dom, null);
            });
        }
        //todo 概念
        function stage(opt){

        }

        //层,主要用来承载图片
        function layer(opt){
            var dom = document.createElement("div");
            dom.style.cssText="display:block;width:560px;height:540px;background-image:url(golden-lamp.png); background-position: -51px 151px;background-repeat: no-repeat;border:1px solid red";

            return dom;
        }

        (NS || window).CSSAnimation = {
            layer:layer,
            animate: animate,

        }
    })(window);
</script>

<!--behind for test -->
<style>

    .outer {
        position: absolute;
        width: 100%;
        height: 100%;
        background: url(background.png) no-repeat ;
        background-size: cover;
    }

    .outer * {
        position: absolute;
        top: 0;
        left: 0;
    }

</style>

<div class="outer" id="outer">

    <div id="lamp-shake"
         style="display:block;width:640px;height:345px;margin-top:400px;background-image:url(golden-lamp.png); background-position: center;background-repeat: no-repeat;border:1px solid red"></div>
    <div id="hand" style="display:block;width:640px;height:345px;margin:200px;background-image:url(hand.png); background-position: center;background-repeat: no-repeat;border:1px solid red">
    </div>
    <div id="blanket-fly"
         style="display:none;;width:570px;height:345px;margin:538px 35px;background-image:url(ani-blanket.png); background-position: center;background-repeat: no-repeat;border:1px solid red"></div>
    <div id="lamp-fly"
         style="display:none;;width:640px;height:345px;margin-top:383px;background-image:url(lamp.png); background-position: center;background-repeat: no-repeat;border:1px solid red">
        24帧
    </div>
    <div id="god"
         style="display:none;;width:560px;height:540px;margin:40px;background-image:url(god.png); background-position: center;background-repeat: no-repeat;border:1px dashed red">
    </div>
    <div id="win"
         style="display:none;;width:640px;height:1136px;background-image:url(card-win.png); background-position: center center;background-repeat: no-repeat;border:1px solid red">
        <form style="margin:380px 270px">
            <input style="width:200px;height:40px;"/>
        </form>
    </div>
</div>
<script>
    //basic fn
    var $ = function(id){return document.getElementById(id)},
            show = function(id){
                $(id).style.display="block";
            },
            hide=function(id){
                var _=$(id);
                _ && (_.style.display="none");
            };
            remove=function(id){
                var _=$(id);
                _ && _.parentNode && (_.parentNode.removeChild(_));
            }

    //动画链条
    function go() {
        Promise.resolve().then(function () {
            return new Promise(function (resolve, reject) {
                //1 灯晃一晃
                var rule = {
                    "0%": {"transform": "rotate(0deg)"},
                    "25%": {"transform": "rotate(-10deg)"},
                    "75%": {"transform": "rotate(15deg)"},
                    "100%": {"transform": "rotate(0deg)"}
                };
                CSSAnimation.animate({
                    dom: "lamp-shake",
                    duration: "0.5s",
                    timing:"ease-in",
                    loop: 2,
                    rule: rule
                }, function () {
                    resolve();
                });
            })
        }).then(function () {
            remove("lamp-shake");
        }).then(function () {
            var p1 = new Promise(function (resolve, reject) {
                //2.1 灯飞
                var rule = {
                    "from": {
                        "transform": "translateX(0px) translateY(0px) scale(1.0) rotate(0deg)"
                    },
                    "25%": {
                        "transform": "translateX(-50px) translateY(100px) scale(1.0) rotate(10deg)"
                    },
                    "50%": {
                        "transform": "translateX(-100px) translateY(200px) scale(0.5) rotate(20deg)"
                    },
                    "to": {
                        "transform": "translateX(-150px) translateY(270px) scale(0.2)  rotate(0deg)"
                    }
                };

                CSSAnimation.animate({
                    dom: "lamp-fly",
                    duration: "1s",
                    rule: rule
                }, function () {
                    console.log("callback: ",this.id)
                    resolve();
                });
            });

            var p2 = new Promise(function (resolve, reject) {
                //2.2 毯飞
                var rule = {};
                //570 *5  * 440
                for (var i = 0, count = 5; i <= count; i++) {
                    var step = parseInt(i / count * 100);
                    rule[ step + "%"] = {
                        "background-position": (-i * 570) + "px 0px"
                    }
                }

                CSSAnimation.animate({
                    dom: "blanket-fly",
                    duration: "1s",
                    timing: "step-start",
                    loop: 1,
                    rule: rule,
                    delay: "0.5s"
                }, function () {
                    resolve();
                });
            });

            return Promise.all([p1, p2]);
        }).then(function () {
            remove("blanket-fly");
        }).then(function () {
            return new Promise(function(resolve,reject){
                //3 神出
                var rule = {
                    "from": { "transform": "translateX(-100px) translateY(470px) scale(0.1)" },
                    "to":   { "transform": "translateX(50px) translateY(200px) scale(1)"  }
                };

                CSSAnimation.animate({
                    dom: "god",
                    duration: "1s",
                    timing:"ease-in-out",
                    rule: rule
                }, function () {
                    resolve();
                });
            })
        }).then(function () {
           return new Promise(function(resolve,reject){
               remove("god") ;
               remove("lamp-fly") ;
               resolve();
           })
        }).then(function () {
            //4 显示卡片
            return new Promise(function(resolve,reject){
                var rule = {
                    "from": {"transform": "translateY(1200px)"},
                    "to": { "transform": "translateY(0px)" }
                };

                CSSAnimation.animate({
                    dom: "win",
                    duration: "1s",
                    timing:"ease-in-out",
                    rule: rule
                }, function () {
                    console.log("callback: ",this.id);
                    resolve();
                });
            });
        }).catch(function (e) {
            console.log(e);
        })
    };
    window.onload = function () {
        //小手
        CSSAnimation.animate({
            dom: "hand",
            duration: "2s",
            loop:"4",
            timing:"linear",
            delay:"0.5s",
            rule: {
                "from": {"transform": "translateX(0)"},
                "25%": {"transform": "translateX(-100px)" },
                "50%": {"transform": "translateX(0px)" },
                "75%": {"transform": "translateX(-100px)" },
                "to": { "transform": "translateX(0)" }
            }
        });
        document.body.onclick = function () {
            remove("hand");
            go();
        }
    }
</script>
</body>
</html>